# ADR: Архитектура MVP для открытия депозитов онлайн

### **Название задачи:**
Проектирование архитектуры MVP для реализации онлайн-открытия депозитов в банке "Стандарт"

### **Автор:**
Команда цифровой трансформации банка "Стандарт"

### **Дата:**
Октябрь 2025

### **Функциональные требования**

| **№** | **Действующие лица или системы** | **Use Case** | **Описание** |
| :---: | :--- | :--- | :--- |
| UC1 | Новый клиент, Сайт банка | Просмотр депозитных предложений | 1. Клиент заходит на сайт банка<br>2. Просматривает список доступных депозитов<br>3. Видит актуальные ставки по каждому продукту<br>4. Изучает условия депозитов |
| UC2 | Новый клиент, Сайт банка, Система кол-центра | Подача заявки на депозит через сайт | 1. Клиент выбирает депозитный продукт<br>2. Заполняет форму (ФИО, телефон)<br>3. Отправляет заявку<br>4. Получает подтверждение о приеме заявки<br>5. Заявка передается в систему кол-центра |
| UC3 | Оператор кол-центра, Система кол-центра, АБС | Обработка заявки с сайта | 1. Оператор видит новую заявку в системе<br>2. Связывается с клиентом по телефону<br>3. Уточняет детали и предлагает условия<br>4. При необходимости рассчитывает персональную ставку<br>5. Приглашает клиента в отделение для идентификации |
| UC4 | Существующий клиент, Интернет-банк | Просмотр персонализированных предложений | 1. Клиент авторизуется в интернет-банке<br>2. Переходит в раздел депозитов<br>3. Видит список депозитов с базовыми ставками<br>4. Видит персонализированные ставки для себя<br>5. Изучает условия |
| UC5 | Существующий клиент, Интернет-банк, АБС | Открытие депозита в интернет-банке | 1. Клиент выбирает депозитный продукт<br>2. Указывает счет списания и сумму<br>3. Проверяет условия и ставку<br>4. Запрашивает СМС-код<br>5. Вводит СМС-код для подтверждения<br>6. Получает подтверждение о создании заявки |
| UC6 | Менеджер бэк-офиса, АБС | Обработка заявки на депозит | 1. Менеджер видит новую заявку в АБС<br>2. Проверяет данные клиента<br>3. Подтверждает ставку по депозиту<br>4. Одобряет открытие депозита<br>5. Система создает депозитный счет |
| UC7 | Клиент, СМС-шлюз | Получение уведомлений | 1. Клиент получает СМС о приеме заявки<br>2. Получает СМС о подтверждении ставки<br>3. Получает СМС об открытии депозита<br>4. Получает реквизиты депозитного счета |
| UC8 | Менеджер бэк-офиса, Сервис управления ставками | Управление ставками депозитов | 1. Менеджер входит в систему управления ставками<br>2. Просматривает текущие ставки ЦБ<br>3. Анализирует кредитный риск банка<br>4. Рассчитывает новые ставки<br>5. Сохраняет ставки в системе<br>6. Ставки автоматически применяются во всех каналах |

### **Нефункциональные требования**

| **№** | **Требование** |
| :---: | :--- |
| NFR1 | **Производительность:** Время отклика интерфейсов < 2 секунды, отклик API < 100ms |
| NFR2 | **Доступность:** SLA 99.9% (не более 8.76 часов простоя в год), работа 24/7 |
| NFR3 | **Масштабируемость:** Поддержка 1000+ одновременных пользователей с возможностью горизонтального масштабирования |
| NFR4 | **Безопасность:** Шифрование трафика TLS 1.2+, двухфакторная аутентификация через СМС |
| NFR5 | **Надежность:** Работа при сбое основного ЦОД (переключение на резервный), RTO < 1 час, RPO < 15 минут |
| NFR6 | **Интеграция:** Избегать прямых обращений к АБС, использовать асинхронную обработку где возможно |
| NFR7 | **Технологические ограничения:** Использовать существующие БД (Oracle, MS SQL), совместимость с ASP.NET MVC 4.5 |
| NFR8 | **Аудит:** Логирование всех операций с заявками и депозитами для compliance |
| NFR9 | **Кэширование:** Кэширование справочных данных для снижения нагрузки на АБС |
| NFR10 | **Обработка заявок:** Время обработки заявки на депозит не более 30 минут в рабочее время |

### **Решение**

Архитектура MVP построена на принципах:
- **Защита legacy-систем** через API Gateway и кэширование
- **Асинхронная обработка** через очереди сообщений
- **Микросервисный подход** для новой функциональности
- **Событийная архитектура** для уведомлений

#### Ключевые архитектурные решения:

1. **API Gateway (Kong/nginx)**
   - Единая точка входа для всех клиентских приложений
   - Балансировка нагрузки между инстансами сервисов
   - Rate limiting для защиты от перегрузки
   - TLS termination для безопасности
   - Аутентификация и авторизация

2. **Кэширование (Redis Cluster)**
   - Кэширование справочников и ставок (TTL 5 минут)
   - Кэширование сессий пользователей
   - Снижение нагрузки на АБС на 80%
   - Время отклика < 50ms для кэшированных данных

3. **Очередь сообщений (RabbitMQ)**
   - Буферизация запросов к АБС
   - Гарантированная доставка сообщений
   - Асинхронная обработка заявок
   - Event-driven уведомления

4. **Микросервисы**
   - **Сервис депозитов** (Java Spring Boot) - бизнес-логика депозитных продуктов
   - **Сервис управления ставками** (расширение АБС) - централизованное управление ставками
   - **Сервис уведомлений** (Java) - отправка СМС и email
   - **Сервис интеграции с АБС** (C#/.NET) - адаптер для работы с legacy АБС

5. **Мониторинг и логирование**
   - ELK Stack для централизованного логирования
   - Prometheus + Grafana для метрик
   - Jaeger для distributed tracing

#### Интеграционные паттерны:

- **Circuit Breaker** - защита от каскадных сбоев при недоступности внешних систем
- **Retry with exponential backoff** - повторные попытки при временных сбоях
- **Saga pattern** - для распределенных транзакций между микросервисами
- **CQRS** - разделение команд и запросов для оптимизации производительности

#### Развертывание:

- **Multi-ЦОД конфигурация** с active-passive репликацией
- **Контейнеризация** новых сервисов (Docker)
- **Blue-Green deployment** для zero-downtime обновлений

*См. диаграммы C4 модели в файлах:*
- `c4_context_diagram.puml` - контекстная диаграмма
- `c4_container_diagram.puml` - диаграмма контейнеров

### **Альтернативы**

1. **Прямая интеграция с АБС**
   - Плюсы: Проще реализация, меньше компонентов
   - Минусы: Риск перегрузки АБС, невозможность масштабирования, single point of failure
   - Решение: Отклонено из-за критичности АБС для банка

2. **Полная замена интернет-банка**
   - Плюсы: Современный стек, лучшая производительность
   - Минусы: Высокая стоимость, длительная миграция, риски для существующих клиентов
   - Решение: Отложено до следующей фазы

3. **Использование Kafka вместо RabbitMQ**
   - Плюсы: Лучшая производительность, больше возможностей
   - Минусы: Несовместимость с текущей версией интернет-банка, сложнее в поддержке
   - Решение: Запланировано на будущее после обновления интернет-банка

4. **Синхронная обработка всех операций**
   - Плюсы: Проще отладка, предсказуемое поведение
   - Минусы: Медленный отклик, блокировка при сбоях
   - Решение: Отклонено в пользу асинхронной модели

### **Недостатки, ограничения, риски**

#### Недостатки выбранного решения:

1. **Сложность архитектуры**
   - Множество компонентов требует квалифицированной поддержки
   - Сложнее отладка распределенных транзакций
   - Необходимость в специализированном мониторинге

2. **Eventual consistency**
   - Данные могут быть не синхронизированы мгновенно
   - Требуется обработка конфликтов

#### Ограничения:

1. **Технологические**
   - Вертикальное масштабирование АБС (ограничение Oracle)
   - Batch-интеграция с кредитным конвейером (раз в сутки)
   - Использование устаревшего ASP.NET MVC 4.5

2. **Организационные**
   - Зависимость от подрядчика для изменений ядра интернет-банка
   - Ограниченная экспертиза в современных технологиях
   - Необходимость обучения персонала

3. **Регуляторные**
   - Обязательная личная идентификация новых клиентов
   - Требования к хранению и обработке персональных данных

#### Риски:

| **Риск** | **Вероятность** | **Влияние** | **Митигация** |
| :--- | :---: | :---: | :--- |
| Перегрузка АБС при росте нагрузки | Высокая | Критическое | Кэширование, rate limiting, очереди |
| Сбой Redis кластера | Средняя | Высокое | Redis Sentinel, резервное копирование |
| Потеря сообщений в очереди | Низкая | Высокое | Persistent queues, подтверждения |
| Несовместимость версий при интеграции | Средняя | Среднее | Версионирование API, regression testing |
| Утечка персональных данных | Низкая | Критическое | Шифрование, аудит доступа, DLP |
| Недоступность СМС-шлюза | Средняя | Среднее | Резервный канал уведомлений (email) |
| Сложность поддержки микросервисов | Высокая | Среднее | Документация, обучение, автоматизация |

#### План митигации основных рисков:

1. **Поэтапное внедрение** с пилотированием на ограниченной группе клиентов
2. **Comprehensive monitoring** всех компонентов с alerting
3. **Chaos engineering** для проверки отказоустойчивости
4. **Регулярное резервное копирование** всех критических данных
5. **Документирование** всех процессов и API
6. **Обучение команды** работе с новыми технологиями
