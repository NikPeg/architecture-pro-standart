# ADR: Интеграция передачи ставок в кол-центры

### **Название задачи:**
Реализация механизма передачи актуальных депозитных ставок в собственный и партнерский кол-центры

### **Автор:**
Команда цифровой трансформации банка "Стандарт"

### **Дата:**
Октябрь 2025

### **Функциональные требования**

| **№** | **Действующие лица или системы** | **Use Case** | **Описание** |
| :---: | :--- | :--- | :--- |
| UC1 | Менеджер бэк-офиса, Сервис управления ставками | Обновление ставок в системе | 1. Менеджер входит в систему управления ставками<br>2. Вводит новые ставки на основе данных ЦБ<br>3. Сохраняет ставки в АБС<br>4. Система автоматически инициирует распространение ставок |
| UC2 | Сервис ставок, Система кол-центра | Автоматическая синхронизация ставок | 1. Сервис ставок публикует событие об изменении<br>2. Система кол-центра получает уведомление<br>3. Запрашивает актуальные ставки через API<br>4. Обновляет локальный кэш ставок<br>5. Ставки становятся доступны операторам |
| UC3 | Оператор кол-центра, Система кол-центра | Консультация клиента по ставкам | 1. Оператор принимает звонок клиента<br>2. Открывает раздел депозитных продуктов<br>3. Видит актуальные ставки в интерфейсе<br>4. Консультирует клиента по условиям<br>5. При необходимости создает заявку |
| UC4 | Сервис ставок, SFTP-сервер | Экспорт ставок для партнера | 1. Сервис ставок получает событие об изменении<br>2. Формирует файл с актуальными ставками (CSV/JSON)<br>3. Подключается к SFTP-серверу<br>4. Загружает файл в согласованную директорию<br>5. Логирует успешную передачу |
| UC5 | Партнерский кол-центр, SFTP-сервер | Получение ставок партнером | 1. Система партнера проверяет SFTP (каждые 15 минут)<br>2. Обнаруживает новый файл со ставками<br>3. Скачивает и валидирует файл<br>4. Импортирует ставки в свою систему<br>5. Удаляет обработанный файл с SFTP |
| UC6 | Оператор партнерского кол-центра | Консультация по актуальным ставкам | 1. Оператор принимает переадресованный звонок<br>2. Открывает справочник ставок в своей системе<br>3. Видит импортированные ставки банка<br>4. Консультирует клиента<br>5. Передает заявку в банк по согласованному каналу |
| UC7 | Система мониторинга | Контроль актуальности ставок | 1. Система проверяет время последнего обновления<br>2. Сравнивает ставки между системами<br>3. При расхождении генерирует алерт<br>4. Отправляет уведомление ответственным<br>5. Логирует инцидент |

### **Нефункциональные требования**

| **№** | **Требование** |
| :---: | :--- |
| NFR1 | **Актуальность данных:** Ставки должны быть синхронизированы во всех системах в течение 15 минут после изменения |
| NFR2 | **Доступность:** Механизм передачи ставок должен работать 24/7 с доступностью 99.5% |
| NFR3 | **Безопасность:** Передача данных через SFTP с использованием SSH-ключей, шифрование файлов |
| NFR4 | **Масштабируемость:** Поддержка подключения до 5 партнерских кол-центров |
| NFR5 | **Формат данных:** Поддержка CSV и JSON форматов для совместимости с разными системами |
| NFR6 | **Версионирование:** Хранение истории изменений ставок за последние 90 дней |
| NFR7 | **Мониторинг:** Автоматическая проверка консистентности данных каждые 30 минут |
| NFR8 | **Отказоустойчивость:** Retry механизм при сбоях передачи (3 попытки с экспоненциальной задержкой) |
| NFR9 | **Аудит:** Логирование всех операций передачи и получения ставок |
| NFR10 | **Производительность:** Генерация и передача файла не более 30 секунд |

### **Решение**

Архитектура решения основана на событийной модели с использованием различных каналов интеграции для внутренних и внешних систем.

#### Ключевые компоненты решения:

1. **Rate Management Service (Сервис управления ставками)**
   - Централизованное хранилище ставок в АБС
   - REST API для внутренних систем
   - Event Publisher для уведомлений об изменениях
   - File Generator для создания экспортных файлов

2. **Rate Distribution Service (Сервис распространения ставок)**
   - Orchestrator для управления процессом распространения
   - API Client для внутренних систем
   - SFTP Client для внешних интеграций
   - Scheduler для периодических задач

3. **SFTP Gateway**
   - Secure File Transfer Protocol сервер
   - Управление SSH-ключами партнеров
   - Директории для каждого партнера
   - Автоматическая очистка старых файлов

4. **Monitoring & Alerting**
   - Health checks всех компонентов
   - Сравнение данных между системами
   - Алерты при расхождениях
   - Dashboard для визуализации статуса

#### Процесс распространения ставок:

**Для собственного кол-центра:**
1. Изменение ставок в Rate Management Service
2. Публикация события в Message Queue
3. Система кол-центра получает уведомление
4. Запрос актуальных ставок через REST API
5. Обновление локального кэша

**Для партнерского кол-центра:**
1. Изменение ставок в Rate Management Service
2. Rate Distribution Service получает событие
3. Генерация файла в согласованном формате
4. Загрузка файла на SFTP-сервер
5. Партнер забирает файл по расписанию

#### Форматы файлов:

**CSV формат:**
```csv
product_code,product_name,currency,min_amount,max_amount,term_days,rate_percent,effective_date
DEP001,"Классический",RUB,10000,1000000,90,8.5,2025-10-06
DEP002,"Накопительный",RUB,1000,500000,180,9.0,2025-10-06
```

**JSON формат:**
```json
{
  "version": "1.0",
  "generated_at": "2025-10-06T00:00:00Z",
  "rates": [
    {
      "product_code": "DEP001",
      "product_name": "Классический",
      "currency": "RUB",
      "min_amount": 10000,
      "max_amount": 1000000,
      "term_days": 90,
      "rate_percent": 8.5,
      "effective_date": "2025-10-06"
    }
  ]
}
```

*См. диаграммы C4 модели в файлах:*
- `c4_context_rates.puml` - контекстная диаграмма
- `c4_component_rates.puml` - диаграмма компонентов

### **Альтернативы**

1. **Direct API интеграция с партнерами**
   - Плюсы: Real-time синхронизация, меньше задержек
   - Минусы: Требует изменений на стороне партнеров, сложнее безопасность
   - Решение: Отклонено из-за технических ограничений партнеров

2. **Email рассылка ставок**
   - Плюсы: Простота реализации, не требует технической интеграции
   - Минусы: Ручная обработка, высокий риск ошибок, задержки
   - Решение: Отклонено из-за требований автоматизации

3. **Shared Database**
   - Плюсы: Мгновенная синхронизация, единый источник данных
   - Минусы: Проблемы безопасности, сложность разграничения доступа
   - Решение: Отклонено по соображениям безопасности

4. **Manual FTP без автоматизации**
   - Плюсы: Полный контроль процесса
   - Минусы: Требует постоянного участия операторов, риск забыть обновить
   - Решение: Отклонено из-за операционных рисков

### **Недостатки, ограничения, риски**

#### Недостатки:

1. **Задержка синхронизации для партнеров**
   - До 15 минут для получения актуальных ставок
   - Возможность консультации по устаревшим данным

2. **Зависимость от SFTP**
   - Single point of failure для партнерских интеграций
   - Необходимость мониторинга доступности

3. **Сложность отладки**
   - Распределенная система с множеством точек интеграции
   - Трудности в трассировке проблем

#### Ограничения:

1. **Технические**
   - Партнеры могут работать только с файлами
   - Ограничение размера файла SFTP (10MB)
   - Поддержка только 2 форматов (CSV, JSON)

2. **Организационные**
   - Необходимость согласования формата с каждым партнером
   - Требуется обучение операторов работе с новым функционалом

3. **Временные**
   - Интервал проверки SFTP партнерами (не чаще 15 минут)
   - Время хранения файлов на SFTP (не более 24 часов)

#### Риски:

| **Риск** | **Вероятность** | **Влияние** | **Митигация** |
| :--- | :---: | :---: | :--- |
| Недоступность SFTP-сервера | Средняя | Высокое | Резервный SFTP, локальное кэширование у партнеров |
| Ошибки в формате файла | Низкая | Среднее | Валидация перед отправкой, версионирование формата |
| Перегрузка при массовом обновлении | Низкая | Низкое | Rate limiting, очередь обработки |
| Несанкционированный доступ к SFTP | Низкая | Критическое | SSH-ключи, IP whitelist, аудит доступа |
| Рассинхронизация данных | Средняя | Высокое | Мониторинг консистентности, автоматическая ресинхронизация |
| Человеческий фактор (неверные ставки) | Средняя | Высокое | Валидация на уровне UI, подтверждение критических изменений |

#### План митигации:

1. **Резервирование SFTP**
   - Основной и резервный SFTP-серверы
   - Автоматическое переключение при сбое
   - Синхронизация между серверами

2. **Кэширование у партнеров**
   - Хранение последних валидных ставок
   - Использование кэша при недоступности новых данных
   - Алерт при использовании устаревших данных

3. **Мониторинг и алертинг**
   - Dashboard с текущим статусом всех интеграций
   - Автоматические проверки консистентности
   - Эскалация при критических расхождениях

4. **Процедуры восстановления**
   - Документированные процессы для каждого сценария сбоя
   - Регулярные учения по восстановлению
   - Контакты ответственных лиц 24/7
