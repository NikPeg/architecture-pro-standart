# ADR: Архитектура системы онлайн-заявок на кредит

### **Название задачи:**
Реализация функционала подачи и обработки кредитных заявок через онлайн-каналы банка "Стандарт"

### **Автор:**
Команда цифровой трансформации банка "Стандарт"

### **Дата:**
Октябрь 2026 (через 12 месяцев после завершения MVP депозитов)

### **Статус:**
Предложено

### **Контекст:**
После успешного запуска MVP для депозитных продуктов необходимо реализовать аналогичную цифровизацию кредитного направления. Ключевые вызовы: batch-интеграция АБС с Кредитным конвейером (раз в сутки), высокая нагрузка на систему скоринга, требование обработки предодобренных заявок в течение одного рабочего дня.

## **Функциональные требования**

### **Use Cases**

| **№** | **Действующие лица или системы** | **Use Case** | **Описание** |
| :---: | :--- | :--- | :--- |
| UC1 | Новый клиент, Сайт банка | Просмотр кредитных предложений | 1. Клиент заходит на сайт банка<br>2. Переходит в раздел кредитов<br>3. Видит список доступных кредитных продуктов<br>4. Просматривает условия и процентные ставки<br>5. Использует кредитный калькулятор |
| UC2 | Новый клиент, Сайт банка, Quick Scoring | Подача заявки с мгновенным решением | 1. Клиент заполняет форму (ФИО, телефон, паспорт)<br>2. Даёт согласие на обработку данных<br>3. Система выполняет быстрый скоринг по БКИ<br>4. Клиент получает предварительное решение<br>5. Получает СМС о необходимости визита в отделение |
| UC3 | Существующий клиент, Интернет-банк | Просмотр предодобренных предложений | 1. Клиент авторизуется в интернет-банке<br>2. Видит баннер с предодобренным кредитом<br>3. Переходит к деталям предложения<br>4. Видит персональные условия и ставку<br>5. Может принять или отклонить предложение |
| UC4 | Существующий клиент, Интернет-банк | Подача заявки на предодобренный кредит | 1. Клиент выбирает предодобренное предложение<br>2. Указывает желаемую сумму и срок<br>3. Выбирает счёт для зачисления средств<br>4. Подтверждает заявку через СМС-код<br>5. Получает уведомление о приёме заявки |
| UC5 | Менеджер отделения, АБС | Продолжение онлайн-заявки | 1. Клиент приходит в отделение<br>2. Менеджер находит заявку по номеру телефона<br>3. Проверяет документы клиента<br>4. Дозаполняет недостающие данные<br>5. Завершает оформление кредита |
| UC6 | Система Pre-approval, Скоринг | Расчёт предодобренных предложений | 1. Система запускает фоновый процесс (ночью)<br>2. Выбирает клиентов для анализа<br>3. Запрашивает скоринг для каждого<br>4. Рассчитывает условия кредита<br>5. Сохраняет предложения в кэше |
| UC7 | Менеджер кредитования, Кредитный конвейер | Обработка заявки в течение дня | 1. Менеджер видит приоритетную заявку<br>2. Проверяет актуальность скоринга<br>3. При необходимости запускает повторный скоринг<br>4. Принимает решение по заявке<br>5. Система отправляет СМС клиенту о решении |
| UC8 | Клиент, Notification Service | Получение уведомлений о статусе | 1. Система меняет статус заявки<br>2. Генерируется событие изменения<br>3. Notification Service получает событие<br>4. Формируется СМС с новым статусом<br>5. Клиент получает СМС-уведомление |

## **Нефункциональные требования**

| **№** | **Требование** | **Описание** | **Приоритет** |
| :---: | :--- | :--- | :---: |
| NFR1 | **Производительность скоринга** | Мгновенный скоринг новых клиентов должен выполняться не более 5 секунд | Высокий |
| NFR2 | **Время обработки заявок** | Предодобренные заявки должны обрабатываться в течение одного рабочего дня (8 часов) | Критический |
| NFR3 | **Доступность сервисов** | SLA 99.9% для критических сервисов (подача заявок, скоринг) | Высокий |
| NFR4 | **Масштабируемость** | Поддержка до 10,000 заявок в день с возможностью роста до 50,000 | Средний |
| NFR5 | **Кэширование предодобрений** | Хранение до 100,000 предодобренных предложений с TTL 30 дней | Средний |
| NFR6 | **Защита системы скоринга** | Rate limiting: не более 100 запросов в минуту на быстрый скоринг | Высокий |
| NFR7 | **Интеграция в обход batch** | Real-time передача приоритетных заявок в Кредитный конвейер | Критический |
| NFR8 | **Безопасность данных** | Шифрование персональных данных at rest и in transit, соответствие 152-ФЗ | Критический |
| NFR9 | **Аудит и compliance** | Полное логирование всех операций с кредитными заявками для ЦБ РФ | Высокий |
| NFR10 | **Отказоустойчивость** | Автоматический failover при сбое, RTO < 15 минут, RPO < 5 минут | Высокий |
| NFR11 | **Мониторинг конверсии** | Real-time дашборды по воронке конверсии заявок | Средний |
| NFR12 | **Совместимость** | Обратная совместимость с существующими процессами в отделениях | Высокий |

## **Решение**

### **Архитектурный подход**

Решение построено на основе событийно-ориентированной архитектуры с использованием микросервисов, развёрнутых поверх существующей инфраструктуры MVP депозитов. Ключевые принципы:

1. **Переиспользование компонентов MVP**
   - API Gateway для маршрутизации и защиты
   - RabbitMQ/Kafka для асинхронного взаимодействия
   - Redis для кэширования
   - Notification Service для уведомлений

2. **Обход ограничений batch-интеграции**
   - Прямая интеграция Credit Application Service с Кредитным конвейером через REST API
   - Приоритетная очередь для предодобренных заявок
   - Event-driven уведомления об изменениях статуса

3. **Оптимизация работы со скорингом**
   - Quick Scoring Adapter для мгновенной оценки по БКИ (упрощённая модель)
   - Pre-approval Service для фонового расчёта предодобрений (ночные батчи)
   - Rate limiting и кэширование результатов скоринга

### **Ключевые компоненты**

#### **1. Credit Application Service** (Java Spring Boot)
- **REST API Controller** - endpoints для создания и управления заявками
- **Application Manager** - бизнес-логика обработки заявок
- **Status Tracker** - отслеживание и изменение статусов
- **Validation Engine** - валидация данных заявки
- **Event Publisher** - публикация событий в очередь
- **Cache Manager** - управление кэшем заявок

#### **2. Pre-approval Service** (Python/Java)
- **Batch Scheduler** - планировщик ночных расчётов
- **Customer Selector** - выбор клиентов для анализа
- **Scoring Orchestrator** - управление запросами к скорингу
- **Offer Calculator** - расчёт персональных условий
- **Cache Writer** - сохранение предложений в Redis
- **Metrics Collector** - сбор метрик эффективности

#### **3. Quick Scoring Adapter** (Java Spring Boot)
- **BKI Gateway** - интеграция с Бюро кредитных историй
- **Scoring Model** - упрощённая модель для быстрой оценки
- **Cache Layer** - кэширование результатов запросов к БКИ
- **Rate Limiter** - ограничение частоты запросов
- **Fallback Handler** - обработка сбоев БКИ

#### **4. Credit Pipeline Gateway** (Java/C#)
- **API Adapter** - REST API для Кредитного конвейера
- **Data Transformer** - преобразование форматов данных
- **Priority Queue Manager** - управление приоритетами заявок
- **Sync Service** - синхронизация статусов
- **Batch Bypass** - механизм обхода batch-процесса

### **Интеграционные потоки**

1. **Поток новой заявки с сайта:**
Сайт → API Gateway → Credit Application Service → Quick Scoring Adapter → БКИ
↓
RabbitMQ → Notification Service → SMS Gateway

2. **Поток предодобренной заявки:**
Интернет-банк → API Gateway → Credit Application Service → Redis Cache
↓
Credit Pipeline Gateway → Кредитный конвейер

3. **Поток расчёта предодобрений:**
Scheduler → Pre-approval Service → Система скоринга
↓
Redis Cache ← Offer Calculator

### **Паттерны и практики**

- **Circuit Breaker** для защиты от каскадных сбоев при недоступности БКИ
- **Saga Pattern** для управления распределёнными транзакциями
- **CQRS** для разделения команд создания заявок и запросов статуса
- **Event Sourcing** для аудита всех изменений заявки
- **Cache-Aside** для предодобренных предложений
- **Priority Queue** для обработки заявок по важности

## **Альтернативы**

### **1. Полная замена Кредитного конвейера**
- **Описание:** Разработка нового конвейера с нуля с поддержкой real-time
- **Плюсы:** Полный контроль, оптимальная архитектура, отсутствие legacy
- **Минусы:** Высокая стоимость, долгая разработка (12+ месяцев), риски миграции
- **Решение:** Отклонено из-за временных и бюджетных ограничений

### **2. Расширение batch-интеграции**
- **Описание:** Увеличение частоты batch до каждого часа
- **Плюсы:** Минимальные изменения, низкий риск
- **Минусы:** Не решает проблему real-time, нагрузка на АБС, сложность синхронизации
- **Решение:** Отклонено, не соответствует требованию обработки в течение дня

### **3. Синхронный скоринг для всех**
- **Описание:** Все заявки проходят полный скоринг в момент подачи
- **Плюсы:** Точная оценка сразу, единообразный процесс
- **Минусы:** Перегрузка системы скоринга, долгое ожидание клиента (до 30 секунд)
- **Решение:** Отклонено из-за ограничений производительности системы скоринга

### **4. Централизованная очередь заявок**
- **Описание:** Единая очередь для всех типов заявок без приоритизации
- **Плюсы:** Простота реализации, справедливость обработки
- **Минусы:** Невозможность гарантировать SLA для предодобренных, неоптимальное использование ресурсов
- **Решение:** Отклонено в пользу приоритетной обработки

### **5. Интеграция через БД**
- **Описание:** Прямая запись в БД Кредитного конвейера минуя API
- **Плюсы:** Максимальная скорость, простота реализации
- **Минусы:** Нарушение изоляции, риски целостности данных, сложность поддержки
- **Решение:** Отклонено по соображениям безопасности и архитектурной чистоты

## **Недостатки, ограничения, риски**

### **Недостатки решения**

1. **Сложность архитектуры**
- Множество новых компонентов увеличивает сложность системы
- Требуется координация между несколькими сервисами
- Сложнее отладка и поиск проблем

2. **Зависимость от внешних систем**
- БКИ может быть недоступно или работать медленно
- Система скоринга имеет ограниченную пропускную способность
- Кредитный конвейер остаётся legacy-системой

3. **Неполная автоматизация**
- Новые клиенты всё ещё должны посетить отделение
- Часть процессов остаётся ручной
- Зависимость от работы менеджеров

### **Ограничения**

#### **Технические ограничения**
- Batch-процесс АБС-Кредитный конвейер остаётся для неприоритетных заявок
- Система скоринга не может обрабатывать более 100 запросов в минуту
- Кредитный конвейер не поддерживает WebSocket или Server-Sent Events
- БКИ имеет лимиты на количество запросов в сутки

#### **Бизнес-ограничения**
- Регуляторные требования по идентификации новых клиентов
- Необходимость личной подписи кредитного договора
- Лимиты на суммы кредитов без личного присутствия
- Требования по хранению данных на территории РФ

#### **Организационные ограничения**
- Необходимость обучения персонала новым процессам
- Сопротивление изменениям со стороны кредитного департамента
- Ограниченная экспертиза в микросервисной архитектуре

### **Риски и митигация**

| **Риск** | **Вероятность** | **Влияние** | **Митигация** |
| :--- | :---: | :---: | :--- |
| Перегрузка системы скоринга | Высокая | Критическое | Rate limiting, кэширование, приоритизация запросов, резервная упрощённая модель |
| Недоступность БКИ | Средняя | Высокое | Circuit breaker, fallback на исторические данные, graceful degradation |
| Сбой Credit Pipeline Gateway | Низкая | Критическое | Резервирование, health checks, автоматический restart, fallback на batch |
| Утечка персональных данных | Низкая | Критическое | Шифрование, аудит доступа, DLP, регулярные security audits |
| Неправильный расчёт предодобрений | Средняя | Высокое | Валидация результатов, A/B тестирование, мониторинг конверсии |
| Отказ Кредитного конвейера от API | Низкая | Высокое | Поэтапное внедрение, согласование с vendor, контрактные обязательства |
| Превышение бюджета проекта | Средняя | Среднее | Поэтапная реализация, MVP подход, переиспользование компонентов |
| Низкая конверсия онлайн-заявок | Средняя | Среднее | UX исследования, A/B тесты, постоянная оптимизация воронки |

### **План митигации критических рисков**

1. **Защита системы скоринга**
- Внедрение API Gateway с rate limiting перед системой скоринга
- Реализация очереди запросов с приоритизацией
- Разработка упрощённой резервной модели скоринга
- Мониторинг нагрузки и автоматическое масштабирование

2. **Обеспечение доступности БКИ**
- Реализация Circuit Breaker с exponential backoff
- Кэширование успешных ответов БКИ на 24 часа
- Fallback на внутренние данные банка при недоступности
- Мониторинг SLA и эскалация проблем

3. **Постепенное внедрение**
- Пилот на 10% клиентов в первый месяц
- Параллельная работа старого и нового процессов
- Возможность быстрого отката изменений
- Поэтапное увеличение нагрузки

### **Метрики успеха**

- Конверсия онлайн-заявок в выданные кредиты > 30%
- Время обработки предодобренной заявки < 4 часов
- Доля цифровых заявок > 50% от общего числа
- NPS клиентов, использовавших онлайн-канал > 70
- Снижение операционных затрат на заявку на 40%
