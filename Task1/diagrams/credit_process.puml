@startuml credit_process
!theme plain
title Процесс открытия кредита (AS-IS)\n\nПроблемы: Длительность до 7 дней | Batch-интеграции | Устаревшие данные\nНет онлайн-подачи | Нет предодобренных предложений | Ручная обработка
skinparam backgroundColor #FEFEFE

actor "Клиент" as CLIENT
participant "Сотрудник\nотделения" as BRANCH
participant "АБС" as ABS
database "Oracle DB\n(АБС)" as ABS_DB
participant "Кредитный\nконвейер" as PIPELINE
database "Oracle DB\n(Конвейер)" as PIPELINE_DB
participant "Менеджер\nкредитования" as CREDIT_MGR
participant "Система\nскоринга" as SCORING
database "PostgreSQL\n(Скоринг)" as SCORING_DB
participant "Бюро кредитных\nисторий" as BKI

== День 0: Подача заявки ==
CLIENT -> BRANCH: Визит в отделение\nдля получения кредита
activate BRANCH
BRANCH -> CLIENT: Сбор документов\nи информации
CLIENT -> BRANCH: Предоставление\nдокументов
BRANCH -> ABS: Создание заявки\nна кредит
activate ABS
ABS -> ABS_DB: Сохранение заявки
activate ABS_DB
ABS_DB --> ABS: OK
deactivate ABS_DB
ABS --> BRANCH: Номер заявки
deactivate ABS
BRANCH -> CLIENT: Заявка принята,\nрешение в течение\nнедели
deactivate BRANCH

== День 1: Batch-передача заявок ==
note over ABS_DB, PIPELINE_DB
    **Ночной batch-процесс**
    Выполняется 1 раз в сутки в 02:00
end note

ABS_DB -> PIPELINE_DB: Batch-передача\nновых заявок\n(раз в сутки)
activate PIPELINE_DB
PIPELINE_DB --> ABS_DB: Подтверждение
deactivate PIPELINE_DB

== День 2-4: Обработка заявки ==
CREDIT_MGR -> PIPELINE: Открытие заявки\nдля обработки
activate PIPELINE
activate CREDIT_MGR
PIPELINE -> PIPELINE_DB: Получение данных\nзаявки
activate PIPELINE_DB
PIPELINE_DB --> PIPELINE: Данные заявки
deactivate PIPELINE_DB

PIPELINE -> SCORING: REST API запрос\nна скоринг
activate SCORING

par Параллельные запросы данных
    SCORING -> BKI: REST API запрос\nкредитной истории
    activate BKI
    BKI --> SCORING: Кредитная история\n(online)
    deactivate BKI
else
    SCORING -> SCORING_DB: Получение данных\nклиента из АБС
    activate SCORING_DB
    note right of SCORING_DB
        Данные из АБС
        загружаются batch
        раз в сутки
    end note
    SCORING_DB --> SCORING: Данные клиента\n(вчерашние)
    deactivate SCORING_DB
else
    SCORING -> SCORING_DB: Получение истории\nплатежей
    activate SCORING_DB
    note right of SCORING_DB
        История платежей
        из Кредитного конвейера
        загружается batch
        раз в сутки
    end note
    SCORING_DB --> SCORING: История платежей\n(вчерашние)
    deactivate SCORING_DB
end

SCORING -> SCORING: ML-модель\nрасчет скоринга
SCORING --> PIPELINE: Скоринговый балл\nи рекомендация
deactivate SCORING

PIPELINE --> CREDIT_MGR: Результаты скоринга\nи данные заявки

CREDIT_MGR -> CREDIT_MGR: Анализ заявки\nи принятие решения
note right of CREDIT_MGR
    Факторы решения:
    • Скоринговый балл
    • Сумма кредита
    • Доход клиента
    • Кредитная история
    • Внутренние лимиты
end note

alt Кредит одобрен
    CREDIT_MGR -> PIPELINE: Одобрение кредита
    PIPELINE -> PIPELINE_DB: Сохранение решения\nстатус = "Одобрен"
    activate PIPELINE_DB
    PIPELINE_DB --> PIPELINE: OK
    deactivate PIPELINE_DB
else Кредит отклонен
    CREDIT_MGR -> PIPELINE: Отказ в кредите
    PIPELINE -> PIPELINE_DB: Сохранение решения\nстатус = "Отклонен"
    activate PIPELINE_DB
    PIPELINE_DB --> PIPELINE: OK
    deactivate PIPELINE_DB
else Требуется доп. информация
    CREDIT_MGR -> PIPELINE: Запрос доп. документов
    PIPELINE -> PIPELINE_DB: Статус = "Ожидание"
    activate PIPELINE_DB
    PIPELINE_DB --> PIPELINE: OK
    deactivate PIPELINE_DB
    note right: Процесс приостановлен\nдо получения документов
end

deactivate PIPELINE
deactivate CREDIT_MGR

== День 5: Batch-передача решений ==
note over PIPELINE_DB, ABS_DB
    **Ночной batch-процесс**
    Передача решений обратно в АБС
end note

PIPELINE_DB -> ABS_DB: Batch-передача\nрешений по кредитам\n(раз в сутки)
activate ABS_DB
ABS_DB --> PIPELINE_DB: Подтверждение
deactivate ABS_DB

== День 6: Исполнение решения ==
alt Кредит одобрен
    ABS -> ABS: Автоматическое\nсоздание кредитного\nдоговора
    activate ABS
    ABS -> ABS_DB: Зачисление средств\nна счет клиента
    activate ABS_DB
    ABS_DB --> ABS: OK
    deactivate ABS_DB
    ABS -> SMS: Отправка СМС\nоб одобрении
    activate SMS
    SMS -> CLIENT: СМС: "Кредит одобрен,\nсредства на счете"
    deactivate SMS
    deactivate ABS
else Кредит отклонен
    ABS -> SMS: Отправка СМС\nоб отказе
    activate ABS
    activate SMS
    SMS -> CLIENT: СМС: "К сожалению,\nв кредите отказано"
    deactivate SMS
    deactivate ABS
end

@enduml
